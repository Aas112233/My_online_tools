<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode & QR Code Generator - My Online Tools</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
    <a href="index.html" class="page-title">My Online Tools</a>
    <nav class="top-nav">
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="calculator.html" class="nav-link" id="calculator-link">Scientific Calculator</a>
            </li>
            <li class="nav-item">
                <a href="barcode.html" class="nav-link active" id="barcode-link">Barcode & QR Code</a>
            </li>
            <li class="nav-item">
                <a href="pdf.html" class="nav-link" id="pdf-link">PDF Tools</a>
            </li>
            <li class="nav-item">
                <a href="design-qr.html" class="nav-link" id="design-qr-link">Design QR Code</a>
            </li>
            <li class="nav-item">
                <a href="extra.html" class="nav-link" id="extra-link">Extra Tools</a>
            </li>
        </ul>
    </nav>
    
    <div class="content-container">
        <div class="tool-section">
            <h2>Barcode & QR Code Generator</h2>
            
            <!-- Barcode Preview Window -->
            <div class="barcode-preview">
                <svg id="barcode"></svg>
                <div id="qrcode" style="display: none;"></div>
                <span id="invalid" style="display: none;">Not valid data for this barcode type!</span>
            </div>
            
            <!-- Bulk Generation Container -->
            <div id="bulk-barcode-container" style="display: none; margin-top: 20px;">
                <div id="bulk-barcode-grid" class="bulk-barcode-grid"></div>
                <!-- Download PDF Button for Bulk Barcodes -->
                <div id="bulk-download-section" style="margin-top: 20px; text-align: center; display: none;">
                    <button id="download-bulk-pdf" class="btn btn-primary" style="padding: 10px 20px;">
                        <i class="fa fa-download"></i> Download All Barcodes as PDF
                    </button>
                    <!-- PDF Customization Dropdown -->
                    <div class="pdf-customization" style="display: inline-block; position: relative; margin-left: 10px;">
                        <button id="pdf-settings-btn" class="btn" style="padding: 10px 15px;">
                            <i class="fa fa-cog"></i> Settings
                        </button>
                        <div id="pdf-settings-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; min-width: 250px; z-index: 1000; text-align: left;">
                            <h4 style="margin-top: 0; margin-bottom: 15px; color: #333;">PDF Settings</h4>
                            <div class="setting-row" style="margin-bottom: 12px;">
                                <label for="barcodes-per-page" style="display: block; margin-bottom: 5px; font-weight: 500;">Barcodes per page:</label>
                                <select id="barcodes-per-page" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="4">4 barcodes (2x2 grid)</option>
                                    <option value="6">6 barcodes (2x3 grid)</option>
                                    <option value="8" selected>8 barcodes (2x4 grid)</option>
                                    <option value="9">9 barcodes (3x3 grid)</option>
                                    <option value="12">12 barcodes (3x4 grid)</option>
                                    <option value="16">16 barcodes (4x4 grid)</option>
                                </select>
                            </div>
                            <div class="setting-row" style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                    <input type="checkbox" id="include-values" checked style="margin-right: 5px;"> 
                                    Include barcode values
                                </label>
                            </div>
                            <button id="apply-settings" class="btn btn-primary" style="width: 100%;">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Input and Main Controls -->
            <div class="barcode-input-container">
                <input type="text" id="userInput" class="barcode-text-input" value="Example 1234" placeholder="Enter text to encode">
                <textarea id="bulkUserInput" class="barcode-text-input" style="display: none; height: 150px; resize: vertical;" placeholder="Enter one barcode value per line&#10;Example 1234&#10;Example 5678&#10;Example 9012"></textarea>
                <button id="generate-button" class="generate-btn">Generate</button>
                <select id="barcodeType" class="barcode-type-select">
                    <option value="CODE128">CODE128</option>
                    <option value="CODE128A">CODE128A</option>
                    <option value="CODE128B">CODE128B</option>
                    <option value="CODE128C">CODE128C</option>
                    <option value="EAN13">EAN13</option>
                    <option value="EAN8">EAN8</option>
                    <option value="EAN5">EAN5</option>
                    <option value="EAN2">EAN2</option>
                    <option value="UPC">UPC</option>
                    <option value="UPCE">UPCE</option>
                    <option value="CODE39">CODE39</option>
                    <option value="ITF14">ITF14</option>
                    <option value="ITF">ITF</option>
                    <option value="MSI">MSI</option>
                    <option value="MSI10">MSI10</option>
                    <option value="MSI11">MSI11</option>
                    <option value="MSI1010">MSI1010</option>
                    <option value="MSI1110">MSI1110</option>
                    <option value="pharmacode">Pharmacode</option>
                    <option value="codabar">Codabar</option>
                    <option value="code93">CODE93</option>
                    <option value="QR" selected>QR Code</option>
                </select>
            </div>
            
            <!-- Mode Toggle Buttons -->
            <div class="mode-toggle-container" style="display: flex; gap: 10px; margin: 10px 0;">
                <button id="single-mode-btn" class="btn btn-primary">Single Barcode</button>
                <button id="bulk-mode-btn" class="btn">Bulk Generation</button>
            </div>
            
            <!-- Advanced Options Toggle -->
            <div class="advanced-options-toggle">
                <button id="toggle-advanced" class="toggle-btn">
                    <span>Advanced Options</span>
                    <span class="arrow">▼</span>
                </button>
            </div>
            
            <!-- Advanced Options Container -->
            <div id="advanced-options" class="advanced-options-container">
                <div class="options-columns">
                    <!-- Left Column -->
                    <div class="options-column">
                        <!-- Bar Width -->
                        <div class="option-row">
                            <label for="bar-width">Bar Width</label>
                            <div class="option-controls">
                                <input id="bar-width" type="range" min="1" max="4" step="1" value="2">
                                <span id="bar-width-display">2</span>
                            </div>
                        </div>
                        
                        <!-- Height -->
                        <div class="option-row">
                            <label for="bar-height">Height</label>
                            <div class="option-controls">
                                <input id="bar-height" type="range" min="10" max="150" step="5" value="100">
                                <span id="bar-height-display">100</span>
                            </div>
                        </div>
                        
                        <!-- Margin -->
                        <div class="option-row">
                            <label for="bar-margin">Margin</label>
                            <div class="option-controls">
                                <input id="bar-margin" type="range" min="0" max="25" step="1" value="10">
                                <span id="bar-margin-display">10</span>
                            </div>
                        </div>
                        
                        <!-- Background Color -->
                        <div class="option-row">
                            <label for="background-color">Background</label>
                            <div class="option-controls">
                                <input id="background-color" class="color-picker" value="#FFFFFF" type="color">
                            </div>
                        </div>
                        
                        <!-- Line Color -->
                        <div class="option-row">
                            <label for="line-color">Line Color</label>
                            <div class="option-controls">
                                <input id="line-color" class="color-picker" value="#000000" type="color">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="options-column">
                        <!-- Show Text -->
                        <div class="option-row">
                            <label>Show Text</label>
                            <div class="option-controls">
                                <button class="btn btn-primary display-text" value="true">Show</button>
                                <button class="btn display-text" value="false">Hide</button>
                            </div>
                        </div>
                        
                        <!-- Text Align -->
                        <div class="option-row">
                            <label>Text Align</label>
                            <div class="option-controls">
                                <button class="btn text-align" value="left">Left</button>
                                <button class="btn btn-primary text-align" value="center">Center</button>
                                <button class="btn text-align" value="right">Right</button>
                            </div>
                        </div>
                        
                        <!-- Font -->
                        <div class="option-row">
                            <label for="font">Font</label>
                            <div class="option-controls">
                                <select class="form-control" id="font">
                                    <option value="monospace" selected>Monospace</option>
                                    <option value="sans-serif">Sans-serif</option>
                                    <option value="serif">Serif</option>
                                    <option value="fantasy">Fantasy</option>
                                    <option value="cursive">Cursive</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Font Options -->
                        <div class="option-row">
                            <label>Font Options</label>
                            <div class="option-controls">
                                <button class="btn font-option" value="bold">Bold</button>
                                <button class="btn font-option" value="italic">Italic</button>
                            </div>
                        </div>
                        
                        <!-- Font Size -->
                        <div class="option-row">
                            <label for="bar-fontSize">Font Size</label>
                            <div class="option-controls">
                                <input id="bar-fontSize" type="range" min="8" max="36" step="1" value="20">
                                <span id="bar-fontSize-display">20</span>
                            </div>
                        </div>
                        
                        <!-- Text Margin -->
                        <div class="option-row">
                            <label for="bar-text-margin">Text Margin</label>
                            <div class="option-controls">
                                <input id="bar-text-margin" type="range" min="-15" max="40" step="1" value="0">
                                <span id="bar-text-margin-display">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.12.1/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Barcode generation functionality
        document.addEventListener('DOMContentLoaded', function() {
            const barcodeElement = document.getElementById('barcode');
            const qrcodeElement = document.getElementById('qrcode');
            const userInput = document.getElementById('userInput');
            const bulkUserInput = document.getElementById('bulkUserInput');
            const barcodeType = document.getElementById('barcodeType');
            const invalidMessage = document.getElementById('invalid');
            const generateButton = document.getElementById('generate-button');
            const toggleAdvanced = document.getElementById('toggle-advanced');
            const advancedOptions = document.getElementById('advanced-options');
            const bulkBarcodeContainer = document.getElementById('bulk-barcode-container');
            const bulkBarcodeGrid = document.getElementById('bulk-barcode-grid');
            const singleModeBtn = document.getElementById('single-mode-btn');
            const bulkModeBtn = document.getElementById('bulk-mode-btn');
            
            // PDF download button
            const downloadBulkPdfBtn = document.getElementById('download-bulk-pdf');
            const bulkDownloadSection = document.getElementById('bulk-download-section');
            
            // Control elements
            const barWidth = document.getElementById('bar-width');
            const barHeight = document.getElementById('bar-height');
            const barMargin = document.getElementById('bar-margin');
            const backgroundColor = document.getElementById('background-color');
            const lineColor = document.getElementById('line-color');
            const displayTextButtons = document.querySelectorAll('.display-text');
            const textAlignButtons = document.querySelectorAll('.text-align');
            const fontSelect = document.getElementById('font');
            const fontOptionButtons = document.querySelectorAll('.font-option');
            const barFontSize = document.getElementById('bar-fontSize');
            const barTextMargin = document.getElementById('bar-text-margin');
            
            // Display value elements
            const barWidthDisplay = document.getElementById('bar-width-display');
            const barHeightDisplay = document.getElementById('bar-height-display');
            const barMarginDisplay = document.getElementById('bar-margin-display');
            const barFontSizeDisplay = document.getElementById('bar-fontSize-display');
            const barTextMarginDisplay = document.getElementById('bar-text-margin-display');
            
            // QR Code instance
            let qrCodeInstance = null;
            
            // Mode state
            let isBulkMode = false;
            
            // Toggle advanced options
            toggleAdvanced.addEventListener('click', function() {
                const isExpanded = advancedOptions.style.display === 'block';
                advancedOptions.style.display = isExpanded ? 'none' : 'block';
                const arrow = this.querySelector('.arrow');
                arrow.textContent = isExpanded ? '▼' : '▲';
            });
            
            // Toggle between single and bulk mode
            singleModeBtn.addEventListener('click', function() {
                isBulkMode = false;
                singleModeBtn.classList.add('btn-primary');
                bulkModeBtn.classList.remove('btn-primary');
                userInput.style.display = 'block';
                bulkUserInput.style.display = 'none';
                barcodeElement.parentElement.style.display = 'flex';
                bulkBarcodeContainer.style.display = 'none';
                bulkDownloadSection.style.display = 'none';
            });
            
            bulkModeBtn.addEventListener('click', function() {
                isBulkMode = true;
                bulkModeBtn.classList.add('btn-primary');
                singleModeBtn.classList.remove('btn-primary');
                userInput.style.display = 'none';
                bulkUserInput.style.display = 'block';
                barcodeElement.parentElement.style.display = 'none';
                bulkBarcodeContainer.style.display = 'block';
            });
            
            // Generate barcode function
            function generateBarcode() {
                if (isBulkMode) {
                    generateBulkBarcodes();
                } else {
                    generateSingleBarcode();
                }
            }
            
            // Generate single barcode (original functionality)
            function generateSingleBarcode() {
                const text = userInput.value || 'Example 1234';
                const type = barcodeType.value;
                
                // Clear previous barcode/QR code
                barcodeElement.innerHTML = '';
                qrcodeElement.innerHTML = '';
                invalidMessage.style.display = 'none';
                
                // Handle QR code separately
                if (type === 'QR') {
                    try {
                        // Hide barcode element and show QR code element
                        barcodeElement.style.display = 'none';
                        qrcodeElement.style.display = 'block';
                        
                        // Clear previous QR code if exists
                        if (qrCodeInstance) {
                            qrCodeInstance.clear();
                        }
                        
                        // Create new QR code
                        qrCodeInstance = new QRCode(qrcodeElement, {
                            text: text,
                            width: 200,
                            height: 200,
                            colorDark: lineColor.value,
                            colorLight: backgroundColor.value,
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        console.log('QR code generated successfully');
                    } catch (e) {
                        console.error('QR Code generation error:', e);
                        invalidMessage.style.display = 'block';
                        qrcodeElement.style.display = 'none';
                    }
                    return;
                }
                
                // Handle regular barcodes
                // Hide QR code element and show barcode element
                qrcodeElement.style.display = 'none';
                barcodeElement.style.display = 'block';
                
                const settings = {
                    format: type,
                    width: parseInt(barWidth.value),
                    height: parseInt(barHeight.value),
                    margin: parseInt(barMargin.value),
                    background: backgroundColor.value,
                    lineColor: lineColor.value,
                    displayValue: document.querySelector('.display-text.btn-primary').value === 'true',
                    textAlign: document.querySelector('.text-align.btn-primary').value,
                    font: fontSelect.value,
                    fontSize: parseInt(barFontSize.value),
                    textMargin: parseInt(barTextMargin.value)
                };
                
                // Handle font options
                const fontOptions = [];
                fontOptionButtons.forEach(button => {
                    if (button.classList.contains('btn-primary')) {
                        fontOptions.push(button.value);
                    }
                });
                
                if (fontOptions.includes('bold')) settings.fontOptions = settings.fontOptions ? settings.fontOptions + ' bold' : 'bold';
                if (fontOptions.includes('italic')) settings.fontOptions = settings.fontOptions ? settings.fontOptions + ' italic' : 'italic';
                
                try {
                    console.log('Generating barcode with settings:', settings);
                    JsBarcode(barcodeElement, text, settings);
                    invalidMessage.style.display = 'none';
                    barcodeElement.style.display = 'block';
                    console.log('Barcode generated successfully');
                } catch (e) {
                    console.error('Barcode generation error:', e);
                    invalidMessage.style.display = 'block';
                    barcodeElement.style.display = 'none';
                }
            }
            
            // Generate bulk barcodes
            function generateBulkBarcodes() {
                const bulkText = bulkUserInput.value;
                if (!bulkText.trim()) {
                    bulkBarcodeGrid.innerHTML = '<p>Please enter at least one barcode value.</p>';
                    bulkDownloadSection.style.display = 'none';
                    return;
                }
                
                // Split text by new lines and filter out empty lines
                const barcodeValues = bulkText.split('\n').filter(line => line.trim() !== '');
                
                // Clear previous bulk barcodes
                bulkBarcodeGrid.innerHTML = '';
                
                // Show download section if we have barcodes
                bulkDownloadSection.style.display = barcodeValues.length > 0 ? 'block' : 'none';
                
                // Generate a barcode for each value
                barcodeValues.forEach((value, index) => {
                    const barcodeItem = document.createElement('div');
                    barcodeItem.className = 'bulk-barcode-item';
                    barcodeItem.innerHTML = `
                        <div class="barcode-value" title="${value}">${value.length > 30 ? value.substring(0, 30) + '...' : value}</div>
                        <div class="barcode-container">
                            <svg class="bulk-barcode-svg"></svg>
                            <div class="qrcode-container" style="display: none;"></div>
                            <div class="invalid-message" style="display: none;">Not valid data for this barcode type!</div>
                        </div>
                    `;
                    
                    bulkBarcodeGrid.appendChild(barcodeItem);
                    
                    const barcodeSvg = barcodeItem.querySelector('.bulk-barcode-svg');
                    const qrcodeContainer = barcodeItem.querySelector('.qrcode-container');
                    const invalidMsg = barcodeItem.querySelector('.invalid-message');
                    const type = barcodeType.value;
                    
                    // Handle QR code separately
                    if (type === 'QR') {
                        try {
                            barcodeSvg.style.display = 'none';
                            qrcodeContainer.style.display = 'block';
                            
                            // Create new QR code
                            new QRCode(qrcodeContainer, {
                                text: value,
                                width: 150,
                                height: 150,
                                colorDark: lineColor.value,
                                colorLight: backgroundColor.value,
                                correctLevel: QRCode.CorrectLevel.H
                            });
                            
                            console.log('Bulk QR code generated successfully for:', value);
                        } catch (e) {
                            console.error('Bulk QR Code generation error:', e);
                            invalidMsg.style.display = 'block';
                            qrcodeContainer.style.display = 'none';
                        }
                        return;
                    }
                    
                    // Handle regular barcodes
                    qrcodeContainer.style.display = 'none';
                    barcodeSvg.style.display = 'block';
                    
                    const settings = {
                        format: type,
                        width: parseInt(barWidth.value),
                        height: parseInt(barHeight.value),
                        margin: parseInt(barMargin.value),
                        background: backgroundColor.value,
                        lineColor: lineColor.value,
                        displayValue: document.querySelector('.display-text.btn-primary').value === 'true',
                        textAlign: document.querySelector('.text-align.btn-primary').value,
                        font: fontSelect.value,
                        fontSize: parseInt(barFontSize.value),
                        textMargin: parseInt(barTextMargin.value)
                    };
                    
                    // Handle font options
                    const fontOptions = [];
                    fontOptionButtons.forEach(button => {
                        if (button.classList.contains('btn-primary')) {
                            fontOptions.push(button.value);
                        }
                    });
                    
                    if (fontOptions.includes('bold')) settings.fontOptions = settings.fontOptions ? settings.fontOptions + ' bold' : 'bold';
                    if (fontOptions.includes('italic')) settings.fontOptions = settings.fontOptions ? settings.fontOptions + ' italic' : 'italic';
                    
                    try {
                        console.log('Generating bulk barcode with settings:', settings);
                        JsBarcode(barcodeSvg, value, settings);
                        invalidMsg.style.display = 'none';
                        console.log('Bulk barcode generated successfully for:', value);
                    } catch (e) {
                        console.error('Bulk barcode generation error:', e);
                        invalidMsg.style.display = 'block';
                        barcodeSvg.style.display = 'none';
                    }
                });
            }
            
            // PDF customization elements
            const pdfSettingsBtn = document.getElementById('pdf-settings-btn');
            const pdfSettingsDropdown = document.getElementById('pdf-settings-dropdown');
            const barcodesPerPageSelect = document.getElementById('barcodes-per-page');
            const includeValuesCheckbox = document.getElementById('include-values');
            const applySettingsBtn = document.getElementById('apply-settings');
            
            // PDF settings
            let pdfSettings = {
                barcodesPerPage: 8,
                includeValues: true
            };
            
            // Toggle PDF settings dropdown
            if (pdfSettingsBtn) {
                pdfSettingsBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isExpanded = pdfSettingsDropdown.style.display === 'block';
                    pdfSettingsDropdown.style.display = isExpanded ? 'none' : 'block';
                });
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (pdfSettingsDropdown && !pdfSettingsDropdown.contains(e.target) && 
                    pdfSettingsBtn && !pdfSettingsBtn.contains(e.target)) {
                    pdfSettingsDropdown.style.display = 'none';
                }
            });
            
            // Apply PDF settings
            if (applySettingsBtn) {
                applySettingsBtn.addEventListener('click', function() {
                    pdfSettings.barcodesPerPage = parseInt(barcodesPerPageSelect.value);
                    pdfSettings.includeValues = includeValuesCheckbox.checked;
                    pdfSettingsDropdown.style.display = 'none';
                });
            }
            
            // Download bulk barcodes as PDF
            if (downloadBulkPdfBtn) {
                downloadBulkPdfBtn.addEventListener('click', function() {
                    downloadBulkBarcodesAsPDF();
                });
            }
            
            // Function to download all bulk barcodes as PDF
            function downloadBulkBarcodesAsPDF() {
                const { jsPDF } = window.jspdf;
                const bulkItems = document.querySelectorAll('.bulk-barcode-item');
                
                if (bulkItems.length === 0) {
                    alert('No barcodes to download.');
                    return;
                }
                
                // Show loading message
                const originalText = downloadBulkPdfBtn.innerHTML;
                downloadBulkPdfBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Generating PDF...';
                downloadBulkPdfBtn.disabled = true;
                
                // Add a small delay to ensure all barcodes are fully rendered
                setTimeout(() => {
                    try {
                        // Create a new PDF
                        const doc = new jsPDF('p', 'mm', 'a4');
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
                        const margin = 10;
                        const contentWidth = pageWidth - 2 * margin;
                        const contentHeight = pageHeight - 2 * margin;
                        
                        // Calculate grid layout based on barcodes per page setting
                        let cols, rows;
                        switch(pdfSettings.barcodesPerPage) {
                            case 4: 
                                cols = 2; 
                                rows = 2; 
                                break;
                            case 6: 
                                cols = 2; 
                                rows = 3; 
                                break;
                            case 8: 
                                cols = 2; 
                                rows = 4; 
                                break;
                            case 9: 
                                cols = 3; 
                                rows = 3; 
                                break;
                            case 12: 
                                cols = 3; 
                                rows = 4; 
                                break;
                            case 16: 
                                cols = 4; 
                                rows = 4; 
                                break;
                            default: 
                                cols = 2; 
                                rows = 4;
                        }
                        
                        const cellWidth = (contentWidth - (cols - 1) * 5) / cols;
                        const cellHeight = (contentHeight - (rows - 1) * 5) / rows;
                        
                        // Use html2canvas to capture each barcode item and add to PDF
                        const promises = [];
                        bulkItems.forEach((item, index) => {
                            promises.push(
                                html2canvas(item, {
                                    scale: 2, // Higher quality for better scanning
                                    useCORS: true,
                                    allowTaint: true,
                                    logging: false,
                                    backgroundColor: null
                                }).then(canvas => {
                                    return { index, canvas, value: item.querySelector('.barcode-value').textContent };
                                })
                            );
                        });
                        
                        // Process all barcodes when captured
                        Promise.all(promises).then(results => {
                            // Sort by index to maintain order
                            results.sort((a, b) => a.index - b.index);
                            
                            let currentX = margin;
                            let currentY = margin;
                            let colIndex = 0;
                            let rowIndex = 0;
                            let itemsOnPage = 0;
                            
                            // Add title on first page
                            doc.setFontSize(18);
                            doc.setTextColor(0, 0, 0);
                            doc.text('Bulk Barcodes Report', pageWidth / 2, currentY + 10, null, null, 'center');
                            currentY += 20;
                            
                            results.forEach((result, idx) => {
                                const imgData = result.canvas.toDataURL('image/png');
                                
                                // Position for current barcode
                                currentX = margin + (colIndex * (cellWidth + 5));
                                
                                // Add barcode value if enabled
                                let valueHeight = 0;
                                if (pdfSettings.includeValues) {
                                    valueHeight = 7;
                                    doc.setFontSize(8);
                                    doc.setTextColor(0, 0, 0);
                                    // Truncate value if too long
                                    const displayValue = result.value.length > 30 ? result.value.substring(0, 30) + '...' : result.value;
                                    doc.text(displayValue, currentX + cellWidth/2, currentY + valueHeight, null, null, 'center');
                                }
                                
                                // Calculate image dimensions to fit in cell
                                const imgWidth = cellWidth - 10;
                                const imgHeight = (result.canvas.height * imgWidth) / result.canvas.width;
                                const imgY = currentY + valueHeight + 2;
                                
                                // Add image to PDF
                                doc.addImage(imgData, 'PNG', currentX + 5, imgY, imgWidth, imgHeight);
                                
                                // Move to next position
                                colIndex++;
                                itemsOnPage++;
                                
                                if (colIndex >= cols) {
                                    colIndex = 0;
                                    rowIndex++;
                                }
                                
                                // Check if we need a new page
                                if (itemsOnPage >= pdfSettings.barcodesPerPage || 
                                    (rowIndex >= rows && colIndex === 0)) {
                                    // Add new page if there are more barcodes
                                    if (idx < results.length - 1) {
                                        doc.addPage();
                                        rowIndex = 0;
                                        colIndex = 0;
                                        itemsOnPage = 0;
                                        currentY = margin;
                                        
                                        // Add title on new page
                                        doc.setFontSize(18);
                                        doc.text('Bulk Barcodes Report (continued)', pageWidth / 2, currentY + 10, null, null, 'center');
                                        currentY += 20;
                                    }
                                } else {
                                    // Move Y position for next row
                                    if (colIndex === 0) {
                                        currentY += cellHeight + 5;
                                    }
                                }
                            });
                            
                            // Save the PDF
                            doc.save('bulk-barcodes.pdf');
                            
                            // Restore button
                            downloadBulkPdfBtn.innerHTML = originalText;
                            downloadBulkPdfBtn.disabled = false;
                        }).catch(error => {
                            console.error('Error generating PDF:', error);
                            alert('Error generating PDF. Please try again.');
                            downloadBulkPdfBtn.innerHTML = originalText;
                            downloadBulkPdfBtn.disabled = false;
                        });
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        alert('Error generating PDF. Please try again.');
                        downloadBulkPdfBtn.innerHTML = originalText;
                        downloadBulkPdfBtn.disabled = false;
                    }
                }, 100); // Small delay to ensure rendering
            }
            
            // Initialize display values
            barWidthDisplay.textContent = barWidth.value;
            barHeightDisplay.textContent = barHeight.value;
            barMarginDisplay.textContent = barMargin.value;
            barFontSizeDisplay.textContent = barFontSize.value;
            barTextMarginDisplay.textContent = barTextMargin.value;
            
            // Initialize with a default barcode
            generateBarcode();
            
            // Generate barcode on button click
            if (generateButton) {
                generateButton.addEventListener('click', generateBarcode);
            }
            
            // Also generate on input change and type change for better UX
            if (userInput) {
                userInput.addEventListener('input', generateBarcode);
            }
            
            if (bulkUserInput) {
                bulkUserInput.addEventListener('input', generateBarcode);
            }
            
            if (barcodeType) {
                barcodeType.addEventListener('change', generateBarcode);
            }
            
            // Add event listeners for all controls
            if (barWidth) {
                barWidth.addEventListener('input', function() {
                    barWidthDisplay.textContent = this.value;
                    generateBarcode();
                });
            }
            
            if (barHeight) {
                barHeight.addEventListener('input', function() {
                    barHeightDisplay.textContent = this.value;
                    generateBarcode();
                });
            }
            
            if (barMargin) {
                barMargin.addEventListener('input', function() {
                    barMarginDisplay.textContent = this.value;
                    generateBarcode();
                });
            }
            
            if (backgroundColor) {
                backgroundColor.addEventListener('input', generateBarcode);
            }
            
            if (lineColor) {
                lineColor.addEventListener('input', generateBarcode);
            }
            
            // Display text buttons
            if (displayTextButtons) {
                // Initialize the first button as active by default
                if (displayTextButtons.length > 0) {
                    displayTextButtons[0].classList.add('btn-primary');
                }
                
                displayTextButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        displayTextButtons.forEach(btn => btn.classList.remove('btn-primary'));
                        this.classList.add('btn-primary');
                        generateBarcode();
                    });
                });
            }
            
            // Text align buttons
            if (textAlignButtons) {
                textAlignButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        textAlignButtons.forEach(btn => btn.classList.remove('btn-primary'));
                        this.classList.add('btn-primary');
                        generateBarcode();
                    });
                });
            }
            
            // Font options buttons
            if (fontOptionButtons) {
                fontOptionButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        this.classList.toggle('btn-primary');
                        generateBarcode();
                    });
                });
            }
            
            if (fontSelect) {
                fontSelect.addEventListener('change', generateBarcode);
            }
            
            if (barFontSize) {
                barFontSize.addEventListener('input', function() {
                    barFontSizeDisplay.textContent = this.value;
                    generateBarcode();
                });
            }
            
            if (barTextMargin) {
                barTextMargin.addEventListener('input', function() {
                    barTextMarginDisplay.textContent = this.value;
                    generateBarcode();
                });
            }
        });
    </script>
</body>
</html>